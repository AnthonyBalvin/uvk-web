---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro';
import MovieBrowser from '../components/MovieBrowser.jsx'; // Usaremos el nuevo componente
import { supabase } from '../lib/supabaseClient.js';

// 1. Cargamos todos los datos necesarios
async function loadData() {
  const { data: peliculas } = await supabase.from('peliculas').select('*');
  const { data: ciudades } = await supabase.from('ciudades').select('*');
  const { data: cines } = await supabase.from('cines').select('*');
  const { data: funciones } = await supabase.from('funciones').select('*');

  // 2. Separamos las películas por estado
  const moviesEnCartelera = (peliculas || []).filter(p => p.estado === 'En cartelera');
  const proximosEstrenos = (peliculas || []).filter(p => p.estado === 'Próximo estreno');

  // 3. Construimos los "shows" para los filtros (solo para cartelera)
  const peliculasMap = new Map(moviesEnCartelera.map(p => [p.id, p]));
  const cinesMap = new Map((cines || []).map(c => [c.id, c]));
  const ciudadesMap = new Map((ciudades || []).map(c => [c.id, c]));

  const shows = [];
  if (funciones) {
    for (const funcion of funciones) {
      const pelicula = peliculasMap.get(funcion.pelicula_id);
      const cine = cinesMap.get(funcion.cine_id);
      const ciudad = cine ? ciudadesMap.get(cine.ciudad_id) : null;
      if (pelicula && cine && ciudad) {
        shows.push({
          id: funcion.id, pelicula: pelicula, cine: { ...cine, ciudad: ciudad },
          fecha_hora: funcion.fecha_hora, sala: funcion.sala,
        });
      }
    }
  }

  // 4. Devolvemos todo lo que el componente necesita
  return {
    moviesEnCartelera,
    proximosEstrenos,
    shows,
    cities: ciudades || [],
    cinemas: cines || [],
  };
}

const data = await loadData();
---
<Layout title="Cartelera - UVK Cines">
  {/* El <main> tiene tu padding y margen originales */}
  <main class="min-h-screen p-8 mt-24">
    {/* 5. Le pasamos todos los datos al nuevo componente. Él se encargará del resto. */}
    <MovieBrowser 
      client:load 
      moviesEnCartelera={data.moviesEnCartelera}
      proximosEstrenos={data.proximosEstrenos}
      shows={data.shows} 
      ciudades={data.cities} 
      cines={data.cinemas} 
    />
  </main>
</Layout>

{/* Aquí colocamos TUS ESTILOS CSS originales para que se apliquen globalmente en esta página */}
<style is:global>
  .border-b-3 {
    border-bottom-width: 3px;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .aspect-\[3\/4\] {
    aspect-ratio: 3/4;
  }
  .movie-card:hover {
    border-color: #e50914 !important;
    box-shadow: 0 25px 50px rgba(229, 9, 20, 0.2) !important;
    transform: translateY(-12px) scale(1.02) !important;
  }
  .group:hover .group-hover\:text-red-500 {
    color: #e50914 !important;
  }
</style>