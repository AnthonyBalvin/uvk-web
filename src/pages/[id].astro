---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabaseClient.js';

export async function getStaticPaths() {
  const { data: peliculas, error } = await supabase
    .from('peliculas')
    .select('id');

  if (error) {
    console.error("Error en getStaticPaths:", error);
    return [];
  }

  return peliculas.map((pelicula) => ({
    params: { id: pelicula.id },
  }));
}

const { id } = Astro.params;

const { data: pelicula, error } = await supabase
  .from('peliculas')
  .select('*')
  .eq('id', id)
  .single();

if (error || !pelicula) {
  return new Response(null, {
    status: 404,
    statusText: 'No encontrado'
  });
}
---

<Layout title={pelicula.titulo}>
  <main class="min-h-screen p-8 mt-20" style="background: linear-gradient(180deg, #f8f5f0 0%, #f2ede6 50%, #ede7dc 100%); color: #2c2c2c;">
    <div class="container mx-auto" style="background-color: transparent;">
      <div class="flex flex-col md:flex-row gap-8">
        <div class="flex-shrink-0">
          <img
            src={pelicula.imagen_url || '/images/placeholder.jpg'}
            alt={`Carátula de ${pelicula.titulo}`}
            class="w-full md:w-96 rounded-lg shadow-xl"
          />
          <button class="mt-6 w-full bg-red-600 text-white py-3 rounded-lg text-lg font-bold hover:bg-red-700 transition-colors duration-200">
            Comprar Entrada
          </button>
        </div>
        
        <div class="flex-1">
          <h1 class="text-5xl font-extrabold mb-4" style="color: #e50914; text-shadow: 2px 2px 4px rgba(229, 9, 20, 0.1);">{pelicula.titulo}</h1>
          <p class="text-xl text-gray-700 mb-2">
            Duración: {pelicula.duracion} min
          </p>
          <p class="text-xl text-gray-700 mb-6">
            Género: {pelicula.genero}
          </p>
          <h2 class="text-3xl font-bold mb-4" style="color: #e50914; text-shadow: 1px 1px 2px rgba(229, 9, 20, 0.1);">Sinopsis</h2>
          <p class="text-gray-700 leading-relaxed">
            {pelicula.sinopsis}
          </p>

          {pelicula.trailer_url && (
            <div class="mt-8">
              <h2 class="text-3xl font-bold mb-4" style="color: #e50914; text-shadow: 1px 1px 2px rgba(229, 9, 20, 0.1);">Tráiler</h2>
              <div class="aspect-w-16 aspect-h-9">
                <iframe
                  class="rounded-lg shadow-lg"
                  width="100%"
                  height="auto"
                  src={pelicula.trailer_url.replace("watch?v=", "embed/")}
                  title={`Tráiler de ${pelicula.titulo}`}
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowFullScreen
                ></iframe>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  .aspect-w-16 {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
  }
  .aspect-w-16 iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
</style>