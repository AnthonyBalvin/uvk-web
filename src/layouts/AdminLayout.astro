---
// src/layouts/AdminLayout.astro
import '../styles/global.css';
const { pathname } = Astro.url;
---
<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración | UVK</title>
  <meta name="robots" content="noindex, nofollow">
</head>
<body class="bg-stone-50 font-sans antialiased">
  <div class="flex min-h-screen">
    
    <!-- SIDEBAR -->
    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col fixed left-0 top-0 bottom-0 z-50 shadow-xl">
      
      <!-- Sidebar Header -->
      <div class="flex items-center gap-3 px-6 py-6 border-b border-gray-100 bg-gradient-to-br from-gray-50 to-white">
        <div class="w-11 h-11 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center shadow-lg shadow-red-200 relative overflow-hidden group">
          <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
          <svg class="w-6 h-6 text-white relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
        </div>
        <span class="text-xl font-bold text-gray-900 tracking-tight">UVK CINES</span>
      </div>

      <!-- Sidebar Navigation (con scroll) -->
      <nav class="flex-1 overflow-y-auto px-4 py-6 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent">
        
        <!-- Principal -->
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-3">Principal</h3>
        <ul class="space-y-1 mb-6">
          <li>
            <a 
              href="/admin" 
              class:list={[
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                pathname === '/admin' 
                  ? "bg-gradient-to-r from-red-600 to-red-700 text-white shadow-md shadow-red-200" 
                  : "text-gray-700 hover:bg-gray-50 hover:text-gray-900"
              ]}
            >
              <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 21h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
              </svg>
              <span>Dashboard</span>
            </a>
          </li>
        </ul>

        <!-- Gestión -->
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-3">Gestión</h3>
        <ul class="space-y-1">
          <li>
            <a 
              href="/admin/peliculas" 
              class:list={[
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                pathname.startsWith('/admin/peliculas')
                  ? "bg-gradient-to-r from-red-600 to-red-700 text-white shadow-md shadow-red-200" 
                  : "text-gray-700 hover:bg-gray-50 hover:text-gray-900"
              ]}
            >
              <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-3.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-1.5A1.125 1.125 0 0118 18.375M20.625 4.5H3.375m17.25 0c.621 0 1.125.504 1.125 1.125M20.625 4.5h-1.5C18.504 4.5 18 5.004 18 5.625m3.75 0v1.5c0 .621-.504 1.125-1.125 1.125M3.375 4.5c-.621 0-1.125.504-1.125 1.125M3.375 4.5h1.5C5.496 4.5 6 5.004 6 5.625m-3.75 0v1.5c0 .621.504 1.125 1.125 1.125m0 0h1.5m-1.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m1.5-3.75C5.496 8.25 6 7.746 6 7.125v-1.5M4.875 8.25C5.496 8.25 6 8.754 6 9.375v1.5m0-5.25v5.25m0-5.25C6 5.004 6.504 4.5 7.125 4.5h9.75c.621 0 1.125.504 1.125 1.125m1.125 2.625h1.5m-1.5 0A1.125 1.125 0 0118 7.125v-1.5m1.125 2.625c-.621 0-1.125.504-1.125 1.125v1.5m2.625-2.625c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125M18 5.625v5.25M7.125 12h9.75m-9.75 0A1.125 1.125 0 016 10.875M7.125 12C6.504 12 6 12.504 6 13.125m0-2.25C6 11.496 5.496 12 4.875 12M18 10.875c0 .621-.504 1.125-1.125 1.125M18 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m-1.125 0h-9.75" />
              </svg>
              <span>Películas</span>
            </a>
          </li>
          <li>
            <a 
              href="/admin/alimentos" 
              class:list={[
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                pathname.startsWith('/admin/alimentos')
                  ? "bg-gradient-to-r from-red-600 to-red-700 text-white shadow-md shadow-red-200" 
                  : "text-gray-700 hover:bg-gray-50 hover:text-gray-900"
              ]}
            >
              <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 22.5l-.648-1.938a3.375 3.375 0 00-2.658-2.658L11.25 18l1.938-.648a3.375 3.375 0 002.658-2.658L16.25 13.5l.648 1.938a3.375 3.375 0 002.658 2.658L21 18l-1.938.648a3.375 3.375 0 00-2.658 2.658z" />
              </svg>
              <span>Alimentos y Bebidas</span>
            </a>
          </li>
          <li>
            <a 
              href="/admin/clientes" 
              class:list={[
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                pathname.startsWith('/admin/clientes')
                  ? "bg-gradient-to-r from-red-600 to-red-700 text-white shadow-md shadow-red-200" 
                  : "text-gray-700 hover:bg-gray-50 hover:text-gray-900"
              ]}
            >
              <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 3.375c-3.418 0-6.167 2.75-6.167 6.167s2.75 6.167 6.167 6.167 6.167-2.75 6.167-6.167S15.418 3.375 12 3.375z" />
              </svg>
              <span>Clientes</span>
            </a>
          </li>
          <li>
            <a 
              href="/admin/ventas" 
              class:list={[
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                pathname.startsWith('/admin/ventas')
                  ? "bg-gradient-to-r from-red-600 to-red-700 text-white shadow-md shadow-red-200" 
                  : "text-gray-700 hover:bg-gray-50 hover:text-gray-900"
              ]}
            >
              <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1.293 1.293c-.63.63-.184 1.707.707 1.707H17.25m-7.5 0v2.25m0 0c0 .621.504 1.125 1.125 1.125h3.75c.621 0 1.125-.504 1.125-1.125v-2.25m0 0l1.293 1.293c.63.63 1.707.184 1.707-.707V16.5m-9 3.75h9" />
              </svg>
              <span>Ventas y Reportes</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Sidebar Footer (siempre visible) -->
      <div class="mt-auto border-t border-gray-100 p-4 bg-gradient-to-br from-gray-50 to-white flex-shrink-0">
        
        <!-- Perfil Admin -->
        <div id="admin-profile" class="flex items-center gap-3 p-3 mb-3 rounded-xl bg-white border border-gray-100 shadow-sm hover:shadow-md hover:border-gray-200 transition-all duration-200">
          <!-- Placeholder inicial -->
          <div class="w-11 h-11 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 animate-pulse flex-shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div class="h-3.5 w-24 bg-gray-200 rounded animate-pulse mb-1.5"></div>
            <div class="h-3 w-32 bg-gray-100 rounded animate-pulse"></div>
          </div>
        </div>

        <!-- Botón Cerrar Sesión -->
        <button 
          id="logout-button"
          class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg font-semibold text-sm shadow-md shadow-red-200 hover:shadow-lg hover:shadow-red-300 hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200"
        >
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"></path>
          </svg>
          <span>Cerrar Sesión</span>
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 ml-72 p-8 bg-stone-50 min-h-screen">
      <slot />
    </main>
  </div>

  <script>
    import { supabase } from '/src/lib/supabaseClient.js';
    window.supabase = supabase;
  </script>

  <script is:inline>
    async function handleLogout() {
      if (!window.supabase) return;
      await window.supabase.auth.signOut();
      window.location.href = '/login';
    }

    async function checkAdminAndDisplayProfile() {
      await new Promise(resolve => setTimeout(resolve, 0)); 
      if (!window.supabase) {
        console.error("Supabase client no se cargó.");
        return;
      }

      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return;
      }

      const { data: profile } = await window.supabase
        .from('perfiles')
        .select('rol, nombre, apellido')
        .eq('id', session.user.id)
        .single();
      
      if (!profile || profile.rol !== 'administrador') {
        await handleLogout();
        window.location.href = '/';
        return;
      }

      const profileContainer = document.getElementById('admin-profile');
      if (profileContainer) {
        const userEmail = session.user.email;
        const userInitial = profile.nombre ? profile.nombre.charAt(0).toUpperCase() : 'A';
        
        profileContainer.innerHTML = `
          <div class="w-11 h-11 rounded-full bg-gradient-to-br from-red-600 to-red-700 flex items-center justify-center text-white font-bold text-lg shadow-md shadow-red-200 flex-shrink-0 relative overflow-hidden group">
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
            <span class="relative z-10">${userInitial}</span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-gray-900 truncate">${profile.nombre || ''} ${profile.apellido || ''}</p>
            <p class="text-xs text-gray-500 truncate">${userEmail}</p>
          </div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkAdminAndDisplayProfile();
      const logoutBtn = document.getElementById('logout-button');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }
    });
  </script>
</body>
</html>