---
// src/layouts/AdminLayout.astro
import '../styles/admin.css';
const { pathname } = Astro.url;
---
<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración | UVK</title>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
        </div>
        <span class="sidebar-title">UVK CINES</span>
      </div>

      <nav class="sidebar-nav">
        <h3 class="nav-category">Principal</h3>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="/admin" class:list={{ active: pathname === '/admin' }}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 21h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
              <span>Dashboard</span>
            </a>
          </li>
        </ul>

        <h3 class="nav-category" style="margin-top: 1.5rem;">Gestión</h3>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="/admin/peliculas" class:list={{ active: pathname.startsWith('/admin/peliculas') }}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 20.25h12m-7.5-3.75v3.75m-3.75-3.75v3.75m-3.75-3.75v3.75m9.75-14.25h1.5m-4.5 0h1.5m-4.5 0h1.5m-4.5 0h1.5m-6.75 4.5h19.5M3.75 6.75h16.5M3.75 12h16.5m-16.5 3.75h16.5M3.75 15.75h16.5M4.5 21v-4.5c0-.621.504-1.125 1.125-1.125h12.75c.621 0 1.125.504 1.125 1.125V21" /></svg>
              <span>Películas</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="/admin/alimentos" class:list={{ active: pathname.startsWith('/admin/alimentos') }}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 22.5l-.648-1.938a3.375 3.375 0 00-2.658-2.658L11.25 18l1.938-.648a3.375 3.375 0 002.658-2.658L16.25 13.5l.648 1.938a3.375 3.375 0 002.658 2.658L21 18l-1.938.648a3.375 3.375 0 00-2.658 2.658z" /></svg>
              <span>Alimentos y Bebidas</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="/admin/clientes" class:list={{ active: pathname.startsWith('/admin/clientes') }}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 3.375c-3.418 0-6.167 2.75-6.167 6.167s2.75 6.167 6.167 6.167 6.167-2.75 6.167-6.167S15.418 3.375 12 3.375z" /></svg>
              <span>Clientes</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="/admin/ventas" class:list={{ active: pathname.startsWith('/admin/ventas') }}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1.293 1.293c-.63.63-.184 1.707.707 1.707H17.25m-7.5 0v2.25m0 0c0 .621.504 1.125 1.125 1.125h3.75c.621 0 1.125-.504 1.125-1.125v-2.25m0 0l1.293 1.293c.63.63 1.707.184 1.707-.707V16.5m-9 3.75h9" /></svg>
              <span>Ventas y Reportes</span>
            </a>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <div id="admin-profile" class="admin-profile">
            <div class="profile-avatar-placeholder"></div>
            <div class="profile-info-placeholder">
                <div class="name-placeholder"></div>
                <div class="email-placeholder"></div>
            </div>
        </div>
        <button id="logout-button">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"></path></svg>
          <span>Cerrar Sesión</span>
        </button>
      </div>
    </aside>

    <main class="main-content">
      <slot />
    </main>
  </div>

  <script>
    import { supabase } from '/src/lib/supabaseClient.js';
    window.supabase = supabase;
  </script>

  <script is:inline>
    // --- SCRIPT ACTUALIZADO ---
    async function handleLogout() {
      if (!window.supabase) return;
      await window.supabase.auth.signOut();
      window.location.href = '/login';
    }

    async function checkAdminAndDisplayProfile() {
      // Espera a que Supabase se cargue
      await new Promise(resolve => setTimeout(resolve, 0)); 
      if (!window.supabase) {
        console.error("Supabase client no se cargó.");
        return;
      }

      // 1. Obtener la sesión del usuario
      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return;
      }

      // 2. Obtener el perfil del usuario (ahora pedimos nombre y apellido también)
      const { data: profile } = await window.supabase
        .from('perfiles')
        .select('rol, nombre, apellido')
        .eq('id', session.user.id)
        .single();
      
      // 3. Verificar si es administrador
      if (!profile || profile.rol !== 'administrador') {
        await handleLogout(); // Si no es admin, cierra sesión por seguridad
        window.location.href = '/';
        return;
      }

      // 4. Si es admin, buscar el contenedor del perfil y llenarlo con los datos
      const profileContainer = document.getElementById('admin-profile');
      if (profileContainer) {
        const userEmail = session.user.email;
        const userInitial = profile.nombre ? profile.nombre.charAt(0).toUpperCase() : 'A';
        
        // Reemplazamos el placeholder con la información real
        profileContainer.innerHTML = `
          <div class="profile-avatar">${userInitial}</div>
          <div class="profile-info">
            <span class="profile-name">${profile.nombre || ''} ${profile.apellido || ''}</span>
            <span class="profile-email">${userEmail}</span>
          </div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkAdminAndDisplayProfile(); // Llamamos a la nueva función
      const logoutBtn = document.getElementById('logout-button');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }
    });
  </script>
</body>
</html>